{"ast":null,"code":"import _regeneratorRuntime from\"/Applications/XAMPP/xamppfiles/htdocs/fohle-interface/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Applications/XAMPP/xamppfiles/htdocs/fohle-interface/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Applications/XAMPP/xamppfiles/htdocs/fohle-interface/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{PERMIT2_ADDRESS}from'@uniswap/permit2-sdk';import{useWeb3React}from'@web3-react/core';import{AVERAGE_L1_BLOCK_TIME}from'constants/chainInfo';import useInterval from'lib/hooks/useInterval';import{useCallback,useEffect,useMemo,useState}from'react';import{useHasPendingApproval}from'state/transactions/hooks';import{usePermitAllowance,useUpdatePermitAllowance}from'./usePermitAllowance';import{useTokenAllowance,useUpdateTokenAllowance}from'./useTokenAllowance';var SyncState;(function(SyncState){SyncState[SyncState[\"PENDING\"]=0]=\"PENDING\";SyncState[SyncState[\"SYNCING\"]=1]=\"SYNCING\";SyncState[SyncState[\"SYNCED\"]=2]=\"SYNCED\";})(SyncState||(SyncState={}));export var PermitState;(function(PermitState){PermitState[PermitState[\"INVALID\"]=0]=\"INVALID\";PermitState[PermitState[\"LOADING\"]=1]=\"LOADING\";PermitState[PermitState[\"APPROVAL_OR_PERMIT_NEEDED\"]=2]=\"APPROVAL_OR_PERMIT_NEEDED\";PermitState[PermitState[\"APPROVAL_LOADING\"]=3]=\"APPROVAL_LOADING\";PermitState[PermitState[\"APPROVED_AND_PERMITTED\"]=4]=\"APPROVED_AND_PERMITTED\";})(PermitState||(PermitState={}));export default function usePermit(amount,spender){var _useWeb3React=useWeb3React(),account=_useWeb3React.account;var _useTokenAllowance=useTokenAllowance(amount===null||amount===void 0?void 0:amount.currency,account,PERMIT2_ADDRESS),tokenAllowance=_useTokenAllowance.tokenAllowance,isApprovalSyncing=_useTokenAllowance.isSyncing;var updateTokenAllowance=useUpdateTokenAllowance(amount,PERMIT2_ADDRESS);var isAllowed=useMemo(function(){return amount&&((tokenAllowance===null||tokenAllowance===void 0?void 0:tokenAllowance.greaterThan(amount))||(tokenAllowance===null||tokenAllowance===void 0?void 0:tokenAllowance.equalTo(amount)));},[amount,tokenAllowance]);var permitAllowance=usePermitAllowance(amount===null||amount===void 0?void 0:amount.currency,spender);var _useState=useState(permitAllowance===null||permitAllowance===void 0?void 0:permitAllowance.amount),_useState2=_slicedToArray(_useState,2),permitAllowanceAmount=_useState2[0],setPermitAllowanceAmount=_useState2[1];useEffect(function(){return setPermitAllowanceAmount(permitAllowance===null||permitAllowance===void 0?void 0:permitAllowance.amount);},[permitAllowance===null||permitAllowance===void 0?void 0:permitAllowance.amount]);var isPermitted=useMemo(function(){return amount&&(permitAllowanceAmount===null||permitAllowanceAmount===void 0?void 0:permitAllowanceAmount.gte(amount.quotient.toString()));},[amount,permitAllowanceAmount]);var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),signature=_useState4[0],setSignature=_useState4[1];var updatePermitAllowance=useUpdatePermitAllowance(amount===null||amount===void 0?void 0:amount.currency,spender,permitAllowance===null||permitAllowance===void 0?void 0:permitAllowance.nonce,setSignature);var isSigned=useMemo(function(){return amount&&(signature===null||signature===void 0?void 0:signature.details.token)===(amount===null||amount===void 0?void 0:amount.currency.address)&&(signature===null||signature===void 0?void 0:signature.spender)===spender;},[amount,signature===null||signature===void 0?void 0:signature.details.token,signature===null||signature===void 0?void 0:signature.spender,spender]);// Trigger a re-render if either tokenAllowance or signature expire.\nuseInterval(function(){// Calculate now such that the signature will still be valid for the next block.\nvar now=(Date.now()-AVERAGE_L1_BLOCK_TIME)/1000;if(signature&&signature.sigDeadline<now){setSignature(undefined);}if(permitAllowance&&permitAllowance.expiration<now){setPermitAllowanceAmount(undefined);}},AVERAGE_L1_BLOCK_TIME,true);// Permit2 should be marked syncing from the time approval is submitted (pending) until it is\n// synced in tokenAllowance, to avoid re-prompting the user for an already-submitted approval.\nvar _useState5=useState(SyncState.SYNCED),_useState6=_slicedToArray(_useState5,2),syncState=_useState6[0],setSyncState=_useState6[1];var isApprovalLoading=syncState!==SyncState.SYNCED;var hasPendingApproval=useHasPendingApproval(amount===null||amount===void 0?void 0:amount.currency,PERMIT2_ADDRESS);useEffect(function(){if(hasPendingApproval){setSyncState(SyncState.PENDING);}else{setSyncState(function(state){if(state===SyncState.PENDING&&isApprovalSyncing){return SyncState.SYNCING;}else if(state===SyncState.SYNCING&&!isApprovalSyncing){return SyncState.SYNCED;}else{return state;}});}},[hasPendingApproval,isApprovalSyncing]);var callback=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var info;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(!isAllowed&&!hasPendingApproval)){_context.next=4;break;}_context.next=3;return updateTokenAllowance();case 3:info=_context.sent;case 4:if(!(!isPermitted&&!isSigned)){_context.next=7;break;}_context.next=7;return updatePermitAllowance();case 7:return _context.abrupt(\"return\",info);case 8:case\"end\":return _context.stop();}}},_callee);})),[hasPendingApproval,isAllowed,isPermitted,isSigned,updatePermitAllowance,updateTokenAllowance]);return useMemo(function(){if(!amount){return{state:PermitState.INVALID};}else if(!tokenAllowance||!permitAllowance){return{state:PermitState.LOADING};}else if(!(isPermitted||isSigned)){return{state:PermitState.APPROVAL_OR_PERMIT_NEEDED,callback:callback};}else if(!isAllowed){return{state:isApprovalLoading?PermitState.APPROVAL_LOADING:PermitState.APPROVAL_OR_PERMIT_NEEDED,callback:callback};}else{return{state:PermitState.APPROVED_AND_PERMITTED,signature:isPermitted?undefined:signature};}},[amount,callback,isAllowed,isApprovalLoading,isPermitted,isSigned,permitAllowance,signature,tokenAllowance]);}","map":{"version":3,"names":["PERMIT2_ADDRESS","useWeb3React","AVERAGE_L1_BLOCK_TIME","useInterval","useCallback","useEffect","useMemo","useState","useHasPendingApproval","usePermitAllowance","useUpdatePermitAllowance","useTokenAllowance","useUpdateTokenAllowance","SyncState","PermitState","usePermit","amount","spender","account","currency","tokenAllowance","isApprovalSyncing","isSyncing","updateTokenAllowance","isAllowed","greaterThan","equalTo","permitAllowance","permitAllowanceAmount","setPermitAllowanceAmount","isPermitted","gte","quotient","toString","signature","setSignature","updatePermitAllowance","nonce","isSigned","details","token","address","now","Date","sigDeadline","undefined","expiration","SYNCED","syncState","setSyncState","isApprovalLoading","hasPendingApproval","PENDING","state","SYNCING","callback","info","INVALID","LOADING","APPROVAL_OR_PERMIT_NEEDED","APPROVAL_LOADING","APPROVED_AND_PERMITTED"],"sources":["/Applications/XAMPP/xamppfiles/htdocs/fohle-interface/src/hooks/usePermit2.ts"],"sourcesContent":["import { ContractTransaction } from '@ethersproject/contracts'\nimport { PERMIT2_ADDRESS } from '@uniswap/permit2-sdk'\nimport { CurrencyAmount, Token } from '@uniswap/sdk-core'\nimport { useWeb3React } from '@web3-react/core'\nimport { AVERAGE_L1_BLOCK_TIME } from 'constants/chainInfo'\nimport useInterval from 'lib/hooks/useInterval'\nimport { useCallback, useEffect, useMemo, useState } from 'react'\nimport { useHasPendingApproval } from 'state/transactions/hooks'\nimport { ApproveTransactionInfo } from 'state/transactions/types'\n\nimport { PermitSignature, usePermitAllowance, useUpdatePermitAllowance } from './usePermitAllowance'\nimport { useTokenAllowance, useUpdateTokenAllowance } from './useTokenAllowance'\n\nenum SyncState {\n  PENDING,\n  SYNCING,\n  SYNCED,\n}\n\nexport enum PermitState {\n  INVALID,\n  LOADING,\n  APPROVAL_OR_PERMIT_NEEDED,\n  APPROVAL_LOADING,\n  APPROVED_AND_PERMITTED,\n}\n\nexport interface Permit {\n  state: PermitState\n  signature?: PermitSignature\n  callback?: () => Promise<{\n    response: ContractTransaction\n    info: ApproveTransactionInfo\n  } | void>\n}\n\nexport default function usePermit(amount?: CurrencyAmount<Token>, spender?: string): Permit {\n  const { account } = useWeb3React()\n  const { tokenAllowance, isSyncing: isApprovalSyncing } = useTokenAllowance(amount?.currency, account, PERMIT2_ADDRESS)\n  const updateTokenAllowance = useUpdateTokenAllowance(amount, PERMIT2_ADDRESS)\n  const isAllowed = useMemo(\n    () => amount && (tokenAllowance?.greaterThan(amount) || tokenAllowance?.equalTo(amount)),\n    [amount, tokenAllowance]\n  )\n\n  const permitAllowance = usePermitAllowance(amount?.currency, spender)\n  const [permitAllowanceAmount, setPermitAllowanceAmount] = useState(permitAllowance?.amount)\n  useEffect(() => setPermitAllowanceAmount(permitAllowance?.amount), [permitAllowance?.amount])\n  const isPermitted = useMemo(\n    () => amount && permitAllowanceAmount?.gte(amount.quotient.toString()),\n    [amount, permitAllowanceAmount]\n  )\n\n  const [signature, setSignature] = useState<PermitSignature>()\n  const updatePermitAllowance = useUpdatePermitAllowance(\n    amount?.currency,\n    spender,\n    permitAllowance?.nonce,\n    setSignature\n  )\n  const isSigned = useMemo(\n    () => amount && signature?.details.token === amount?.currency.address && signature?.spender === spender,\n    [amount, signature?.details.token, signature?.spender, spender]\n  )\n\n  // Trigger a re-render if either tokenAllowance or signature expire.\n  useInterval(\n    () => {\n      // Calculate now such that the signature will still be valid for the next block.\n      const now = (Date.now() - AVERAGE_L1_BLOCK_TIME) / 1000\n      if (signature && signature.sigDeadline < now) {\n        setSignature(undefined)\n      }\n      if (permitAllowance && permitAllowance.expiration < now) {\n        setPermitAllowanceAmount(undefined)\n      }\n    },\n    AVERAGE_L1_BLOCK_TIME,\n    true\n  )\n\n  // Permit2 should be marked syncing from the time approval is submitted (pending) until it is\n  // synced in tokenAllowance, to avoid re-prompting the user for an already-submitted approval.\n  const [syncState, setSyncState] = useState(SyncState.SYNCED)\n  const isApprovalLoading = syncState !== SyncState.SYNCED\n  const hasPendingApproval = useHasPendingApproval(amount?.currency, PERMIT2_ADDRESS)\n  useEffect(() => {\n    if (hasPendingApproval) {\n      setSyncState(SyncState.PENDING)\n    } else {\n      setSyncState((state) => {\n        if (state === SyncState.PENDING && isApprovalSyncing) {\n          return SyncState.SYNCING\n        } else if (state === SyncState.SYNCING && !isApprovalSyncing) {\n          return SyncState.SYNCED\n        } else {\n          return state\n        }\n      })\n    }\n  }, [hasPendingApproval, isApprovalSyncing])\n\n  const callback = useCallback(async () => {\n    let info\n    if (!isAllowed && !hasPendingApproval) {\n      info = await updateTokenAllowance()\n    }\n    if (!isPermitted && !isSigned) {\n      await updatePermitAllowance()\n    }\n    return info\n  }, [hasPendingApproval, isAllowed, isPermitted, isSigned, updatePermitAllowance, updateTokenAllowance])\n\n  return useMemo(() => {\n    if (!amount) {\n      return { state: PermitState.INVALID }\n    } else if (!tokenAllowance || !permitAllowance) {\n      return { state: PermitState.LOADING }\n    } else if (!(isPermitted || isSigned)) {\n      return { state: PermitState.APPROVAL_OR_PERMIT_NEEDED, callback }\n    } else if (!isAllowed) {\n      return {\n        state: isApprovalLoading ? PermitState.APPROVAL_LOADING : PermitState.APPROVAL_OR_PERMIT_NEEDED,\n        callback,\n      }\n    } else {\n      return { state: PermitState.APPROVED_AND_PERMITTED, signature: isPermitted ? undefined : signature }\n    }\n  }, [\n    amount,\n    callback,\n    isAllowed,\n    isApprovalLoading,\n    isPermitted,\n    isSigned,\n    permitAllowance,\n    signature,\n    tokenAllowance,\n  ])\n}\n"],"mappings":"igBACA,OAASA,eAAe,KAAQ,sBAAsB,CAEtD,OAASC,YAAY,KAAQ,kBAAkB,CAC/C,OAASC,qBAAqB,KAAQ,qBAAqB,CAC3D,MAAOC,YAAW,KAAM,uBAAuB,CAC/C,OAASC,WAAW,CAAEC,SAAS,CAAEC,OAAO,CAAEC,QAAQ,KAAQ,OAAO,CACjE,OAASC,qBAAqB,KAAQ,0BAA0B,CAGhE,OAA0BC,kBAAkB,CAAEC,wBAAwB,KAAQ,sBAAsB,CACpG,OAASC,iBAAiB,CAAEC,uBAAuB,KAAQ,qBAAqB,IAE3EC,UAAS,WAATA,SAAS,EAATA,SAAS,CAATA,SAAS,yBAATA,SAAS,CAATA,SAAS,yBAATA,SAAS,CAATA,SAAS,0BAATA,SAAS,GAATA,SAAS,MAMd,UAAYC,YAAW,CAMtB,UANWA,WAAW,EAAXA,WAAW,CAAXA,WAAW,yBAAXA,WAAW,CAAXA,WAAW,yBAAXA,WAAW,CAAXA,WAAW,6DAAXA,WAAW,CAAXA,WAAW,2CAAXA,WAAW,CAAXA,WAAW,0DAAXA,WAAW,GAAXA,WAAW,MAiBvB,cAAe,SAASC,UAAS,CAACC,MAA8B,CAAEC,OAAgB,CAAU,CAC1F,kBAAoBhB,YAAY,EAAE,CAA1BiB,OAAO,eAAPA,OAAO,CACf,uBAAyDP,iBAAiB,CAACK,MAAM,SAANA,MAAM,iBAANA,MAAM,CAAEG,QAAQ,CAAED,OAAO,CAAElB,eAAe,CAAC,CAA9GoB,cAAc,oBAAdA,cAAc,CAAaC,iBAAiB,oBAA5BC,SAAS,CACjC,GAAMC,qBAAoB,CAAGX,uBAAuB,CAACI,MAAM,CAAEhB,eAAe,CAAC,CAC7E,GAAMwB,UAAS,CAAGlB,OAAO,CACvB,iBAAMU,OAAM,GAAK,CAAAI,cAAc,SAAdA,cAAc,iBAAdA,cAAc,CAAEK,WAAW,CAACT,MAAM,CAAC,IAAII,cAAc,SAAdA,cAAc,iBAAdA,cAAc,CAAEM,OAAO,CAACV,MAAM,CAAC,EAAC,GACxF,CAACA,MAAM,CAAEI,cAAc,CAAC,CACzB,CAED,GAAMO,gBAAe,CAAGlB,kBAAkB,CAACO,MAAM,SAANA,MAAM,iBAANA,MAAM,CAAEG,QAAQ,CAAEF,OAAO,CAAC,CACrE,cAA0DV,QAAQ,CAACoB,eAAe,SAAfA,eAAe,iBAAfA,eAAe,CAAEX,MAAM,CAAC,wCAApFY,qBAAqB,eAAEC,wBAAwB,eACtDxB,SAAS,CAAC,iBAAMwB,yBAAwB,CAACF,eAAe,SAAfA,eAAe,iBAAfA,eAAe,CAAEX,MAAM,CAAC,GAAE,CAACW,eAAe,SAAfA,eAAe,iBAAfA,eAAe,CAAEX,MAAM,CAAC,CAAC,CAC7F,GAAMc,YAAW,CAAGxB,OAAO,CACzB,iBAAMU,OAAM,GAAIY,qBAAqB,SAArBA,qBAAqB,iBAArBA,qBAAqB,CAAEG,GAAG,CAACf,MAAM,CAACgB,QAAQ,CAACC,QAAQ,EAAE,CAAC,IACtE,CAACjB,MAAM,CAAEY,qBAAqB,CAAC,CAChC,CAED,eAAkCrB,QAAQ,EAAmB,yCAAtD2B,SAAS,eAAEC,YAAY,eAC9B,GAAMC,sBAAqB,CAAG1B,wBAAwB,CACpDM,MAAM,SAANA,MAAM,iBAANA,MAAM,CAAEG,QAAQ,CAChBF,OAAO,CACPU,eAAe,SAAfA,eAAe,iBAAfA,eAAe,CAAEU,KAAK,CACtBF,YAAY,CACb,CACD,GAAMG,SAAQ,CAAGhC,OAAO,CACtB,iBAAMU,OAAM,EAAI,CAAAkB,SAAS,SAATA,SAAS,iBAATA,SAAS,CAAEK,OAAO,CAACC,KAAK,KAAKxB,MAAM,SAANA,MAAM,iBAANA,MAAM,CAAEG,QAAQ,CAACsB,OAAO,GAAI,CAAAP,SAAS,SAATA,SAAS,iBAATA,SAAS,CAAEjB,OAAO,IAAKA,OAAO,GACvG,CAACD,MAAM,CAAEkB,SAAS,SAATA,SAAS,iBAATA,SAAS,CAAEK,OAAO,CAACC,KAAK,CAAEN,SAAS,SAATA,SAAS,iBAATA,SAAS,CAAEjB,OAAO,CAAEA,OAAO,CAAC,CAChE,CAED;AACAd,WAAW,CACT,UAAM,CACJ;AACA,GAAMuC,IAAG,CAAG,CAACC,IAAI,CAACD,GAAG,EAAE,CAAGxC,qBAAqB,EAAI,IAAI,CACvD,GAAIgC,SAAS,EAAIA,SAAS,CAACU,WAAW,CAAGF,GAAG,CAAE,CAC5CP,YAAY,CAACU,SAAS,CAAC,CACzB,CACA,GAAIlB,eAAe,EAAIA,eAAe,CAACmB,UAAU,CAAGJ,GAAG,CAAE,CACvDb,wBAAwB,CAACgB,SAAS,CAAC,CACrC,CACF,CAAC,CACD3C,qBAAqB,CACrB,IAAI,CACL,CAED;AACA;AACA,eAAkCK,QAAQ,CAACM,SAAS,CAACkC,MAAM,CAAC,yCAArDC,SAAS,eAAEC,YAAY,eAC9B,GAAMC,kBAAiB,CAAGF,SAAS,GAAKnC,SAAS,CAACkC,MAAM,CACxD,GAAMI,mBAAkB,CAAG3C,qBAAqB,CAACQ,MAAM,SAANA,MAAM,iBAANA,MAAM,CAAEG,QAAQ,CAAEnB,eAAe,CAAC,CACnFK,SAAS,CAAC,UAAM,CACd,GAAI8C,kBAAkB,CAAE,CACtBF,YAAY,CAACpC,SAAS,CAACuC,OAAO,CAAC,CACjC,CAAC,IAAM,CACLH,YAAY,CAAC,SAACI,KAAK,CAAK,CACtB,GAAIA,KAAK,GAAKxC,SAAS,CAACuC,OAAO,EAAI/B,iBAAiB,CAAE,CACpD,MAAOR,UAAS,CAACyC,OAAO,CAC1B,CAAC,IAAM,IAAID,KAAK,GAAKxC,SAAS,CAACyC,OAAO,EAAI,CAACjC,iBAAiB,CAAE,CAC5D,MAAOR,UAAS,CAACkC,MAAM,CACzB,CAAC,IAAM,CACL,MAAOM,MAAK,CACd,CACF,CAAC,CAAC,CACJ,CACF,CAAC,CAAE,CAACF,kBAAkB,CAAE9B,iBAAiB,CAAC,CAAC,CAE3C,GAAMkC,SAAQ,CAAGnD,WAAW,sEAAC,iJAEvB,CAACoB,SAAS,EAAI,CAAC2B,kBAAkB,gDACtB5B,qBAAoB,EAAE,QAAnCiC,IAAI,2BAEF,CAAC1B,WAAW,EAAI,CAACQ,QAAQ,gDACrBF,sBAAqB,EAAE,wCAExBoB,IAAI,wDACZ,GAAE,CAACL,kBAAkB,CAAE3B,SAAS,CAAEM,WAAW,CAAEQ,QAAQ,CAAEF,qBAAqB,CAAEb,oBAAoB,CAAC,CAAC,CAEvG,MAAOjB,QAAO,CAAC,UAAM,CACnB,GAAI,CAACU,MAAM,CAAE,CACX,MAAO,CAAEqC,KAAK,CAAEvC,WAAW,CAAC2C,OAAQ,CAAC,CACvC,CAAC,IAAM,IAAI,CAACrC,cAAc,EAAI,CAACO,eAAe,CAAE,CAC9C,MAAO,CAAE0B,KAAK,CAAEvC,WAAW,CAAC4C,OAAQ,CAAC,CACvC,CAAC,IAAM,IAAI,EAAE5B,WAAW,EAAIQ,QAAQ,CAAC,CAAE,CACrC,MAAO,CAAEe,KAAK,CAAEvC,WAAW,CAAC6C,yBAAyB,CAAEJ,QAAQ,CAARA,QAAS,CAAC,CACnE,CAAC,IAAM,IAAI,CAAC/B,SAAS,CAAE,CACrB,MAAO,CACL6B,KAAK,CAAEH,iBAAiB,CAAGpC,WAAW,CAAC8C,gBAAgB,CAAG9C,WAAW,CAAC6C,yBAAyB,CAC/FJ,QAAQ,CAARA,QACF,CAAC,CACH,CAAC,IAAM,CACL,MAAO,CAAEF,KAAK,CAAEvC,WAAW,CAAC+C,sBAAsB,CAAE3B,SAAS,CAAEJ,WAAW,CAAGe,SAAS,CAAGX,SAAU,CAAC,CACtG,CACF,CAAC,CAAE,CACDlB,MAAM,CACNuC,QAAQ,CACR/B,SAAS,CACT0B,iBAAiB,CACjBpB,WAAW,CACXQ,QAAQ,CACRX,eAAe,CACfO,SAAS,CACTd,cAAc,CACf,CAAC,CACJ"},"metadata":{},"sourceType":"module"}