{"ast":null,"code":"import { __assign, __awaiter, __generator } from \"tslib\";\nimport { getGlobalScope } from '../global-scope';\nvar CookieStorage = /** @class */function () {\n  function CookieStorage(options) {\n    this.options = __assign({}, options);\n  }\n  CookieStorage.prototype.isEnabled = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var random, testStrorage, testKey, value, _a;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            /* istanbul ignore if */\n            if (!getGlobalScope()) {\n              return [2 /*return*/, false];\n            }\n            random = String(Date.now());\n            testStrorage = new CookieStorage(this.options);\n            testKey = 'AMP_TEST';\n            _b.label = 1;\n          case 1:\n            _b.trys.push([1, 4, 5, 7]);\n            return [4 /*yield*/, testStrorage.set(testKey, random)];\n          case 2:\n            _b.sent();\n            return [4 /*yield*/, testStrorage.get(testKey)];\n          case 3:\n            value = _b.sent();\n            return [2 /*return*/, value === random];\n          case 4:\n            _a = _b.sent();\n            /* istanbul ignore next */\n            return [2 /*return*/, false];\n          case 5:\n            return [4 /*yield*/, testStrorage.remove(testKey)];\n          case 6:\n            _b.sent();\n            return [7 /*endfinally*/];\n          case 7:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  CookieStorage.prototype.get = function (key) {\n    return __awaiter(this, void 0, void 0, function () {\n      var value;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4 /*yield*/, this.getRaw(key)];\n          case 1:\n            value = _a.sent();\n            if (!value) {\n              return [2 /*return*/, undefined];\n            }\n            try {\n              try {\n                value = decodeURIComponent(atob(value));\n              } catch (_b) {\n                // value not encoded\n              }\n              // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n              return [2 /*return*/, JSON.parse(value)];\n            } catch (_c) {\n              /* istanbul ignore next */\n              return [2 /*return*/, undefined];\n            }\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  CookieStorage.prototype.getRaw = function (key) {\n    var _a;\n    return __awaiter(this, void 0, void 0, function () {\n      var globalScope, cookie, match;\n      return __generator(this, function (_b) {\n        globalScope = getGlobalScope();\n        cookie = (_a = globalScope === null || globalScope === void 0 ? void 0 : globalScope.document.cookie.split('; ')) !== null && _a !== void 0 ? _a : [];\n        match = cookie.find(function (c) {\n          return c.indexOf(key + '=') === 0;\n        });\n        if (!match) {\n          return [2 /*return*/, undefined];\n        }\n        return [2 /*return*/, match.substring(key.length + 1)];\n      });\n    });\n  };\n  CookieStorage.prototype.set = function (key, value) {\n    var _a;\n    return __awaiter(this, void 0, void 0, function () {\n      var expirationDays, expires, expireDate, date, str, globalScope;\n      return __generator(this, function (_b) {\n        try {\n          expirationDays = (_a = this.options.expirationDays) !== null && _a !== void 0 ? _a : 0;\n          expires = value !== null ? expirationDays : -1;\n          expireDate = undefined;\n          if (expires) {\n            date = new Date();\n            date.setTime(date.getTime() + expires * 24 * 60 * 60 * 1000);\n            expireDate = date;\n          }\n          str = \"\".concat(key, \"=\").concat(btoa(encodeURIComponent(JSON.stringify(value))));\n          if (expireDate) {\n            str += \"; expires=\".concat(expireDate.toUTCString());\n          }\n          str += '; path=/';\n          if (this.options.domain) {\n            str += \"; domain=\".concat(this.options.domain);\n          }\n          if (this.options.secure) {\n            str += '; Secure';\n          }\n          if (this.options.sameSite) {\n            str += \"; SameSite=\".concat(this.options.sameSite);\n          }\n          globalScope = getGlobalScope();\n          if (globalScope) {\n            globalScope.document.cookie = str;\n          }\n        } catch (_c) {\n          //\n        }\n        return [2 /*return*/];\n      });\n    });\n  };\n\n  CookieStorage.prototype.remove = function (key) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4 /*yield*/, this.set(key, null)];\n          case 1:\n            _a.sent();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  CookieStorage.prototype.reset = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2 /*return*/];\n      });\n    });\n  };\n\n  return CookieStorage;\n}();\nexport { CookieStorage };","map":{"version":3,"sources":["../../../src/storage/cookie.ts"],"names":[],"mappings":"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","sourcesContent":["import { Storage, CookieStorageOptions } from '@amplitude/analytics-types';\nimport { getGlobalScope } from '../global-scope';\n\nexport class CookieStorage<T> implements Storage<T> {\n  options: CookieStorageOptions;\n\n  constructor(options?: CookieStorageOptions) {\n    this.options = { ...options };\n  }\n\n  async isEnabled(): Promise<boolean> {\n    /* istanbul ignore if */\n    if (!getGlobalScope()) {\n      return false;\n    }\n\n    const random = String(Date.now());\n    const testStrorage = new CookieStorage<string>(this.options);\n    const testKey = 'AMP_TEST';\n    try {\n      await testStrorage.set(testKey, random);\n      const value = await testStrorage.get(testKey);\n      return value === random;\n    } catch {\n      /* istanbul ignore next */\n      return false;\n    } finally {\n      await testStrorage.remove(testKey);\n    }\n  }\n\n  async get(key: string): Promise<T | undefined> {\n    let value = await this.getRaw(key);\n    if (!value) {\n      return undefined;\n    }\n    try {\n      try {\n        value = decodeURIComponent(atob(value));\n      } catch {\n        // value not encoded\n      }\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n      return JSON.parse(value);\n    } catch {\n      /* istanbul ignore next */\n      return undefined;\n    }\n  }\n\n  async getRaw(key: string): Promise<string | undefined> {\n    const globalScope = getGlobalScope();\n    const cookie = globalScope?.document.cookie.split('; ') ?? [];\n    const match = cookie.find((c) => c.indexOf(key + '=') === 0);\n    if (!match) {\n      return undefined;\n    }\n    return match.substring(key.length + 1);\n  }\n\n  async set(key: string, value: T | null): Promise<void> {\n    try {\n      const expirationDays = this.options.expirationDays ?? 0;\n      const expires = value !== null ? expirationDays : -1;\n      let expireDate: Date | undefined = undefined;\n      if (expires) {\n        const date = new Date();\n        date.setTime(date.getTime() + expires * 24 * 60 * 60 * 1000);\n        expireDate = date;\n      }\n      let str = `${key}=${btoa(encodeURIComponent(JSON.stringify(value)))}`;\n      if (expireDate) {\n        str += `; expires=${expireDate.toUTCString()}`;\n      }\n      str += '; path=/';\n      if (this.options.domain) {\n        str += `; domain=${this.options.domain}`;\n      }\n      if (this.options.secure) {\n        str += '; Secure';\n      }\n      if (this.options.sameSite) {\n        str += `; SameSite=${this.options.sameSite}`;\n      }\n      const globalScope = getGlobalScope();\n      if (globalScope) {\n        globalScope.document.cookie = str;\n      }\n    } catch {\n      //\n    }\n  }\n\n  async remove(key: string): Promise<void> {\n    await this.set(key, null);\n  }\n\n  async reset(): Promise<void> {\n    return;\n  }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}