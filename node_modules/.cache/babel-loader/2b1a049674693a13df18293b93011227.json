{"ast":null,"code":"import { __awaiter, __generator, __values } from \"tslib\";\nimport { createGroupIdentifyEvent, createIdentifyEvent, createTrackEvent, createRevenueEvent, createGroupEvent } from './utils/event-builder';\nimport { Timeline } from './timeline';\nimport { buildResult } from './utils/result-builder';\nimport { CLIENT_NOT_INITIALIZED, OPT_OUT_MESSAGE } from './messages';\nvar AmplitudeCore = /** @class */function () {\n  function AmplitudeCore(name) {\n    if (name === void 0) {\n      name = '$default';\n    }\n    this.initializing = false;\n    this.q = [];\n    this.dispatchQ = [];\n    this.logEvent = this.track.bind(this);\n    this.timeline = new Timeline();\n    this.name = name;\n  }\n  AmplitudeCore.prototype._init = function (config) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.config = config;\n            this.timeline.reset();\n            return [4 /*yield*/, this.runQueuedFunctions('q')];\n          case 1:\n            _a.sent();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  AmplitudeCore.prototype.runQueuedFunctions = function (queueName) {\n    return __awaiter(this, void 0, void 0, function () {\n      var queuedFunctions, queuedFunctions_1, queuedFunctions_1_1, queuedFunction, e_1_1;\n      var e_1, _a;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            queuedFunctions = this[queueName];\n            this[queueName] = [];\n            _b.label = 1;\n          case 1:\n            _b.trys.push([1, 6, 7, 8]);\n            queuedFunctions_1 = __values(queuedFunctions), queuedFunctions_1_1 = queuedFunctions_1.next();\n            _b.label = 2;\n          case 2:\n            if (!!queuedFunctions_1_1.done) return [3 /*break*/, 5];\n            queuedFunction = queuedFunctions_1_1.value;\n            return [4 /*yield*/, queuedFunction()];\n          case 3:\n            _b.sent();\n            _b.label = 4;\n          case 4:\n            queuedFunctions_1_1 = queuedFunctions_1.next();\n            return [3 /*break*/, 2];\n          case 5:\n            return [3 /*break*/, 8];\n          case 6:\n            e_1_1 = _b.sent();\n            e_1 = {\n              error: e_1_1\n            };\n            return [3 /*break*/, 8];\n          case 7:\n            try {\n              if (queuedFunctions_1_1 && !queuedFunctions_1_1.done && (_a = queuedFunctions_1.return)) _a.call(queuedFunctions_1);\n            } finally {\n              if (e_1) throw e_1.error;\n            }\n            return [7 /*endfinally*/];\n          case 8:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  AmplitudeCore.prototype.track = function (eventInput, eventProperties, eventOptions) {\n    var event = createTrackEvent(eventInput, eventProperties, eventOptions);\n    return this.dispatch(event);\n  };\n  AmplitudeCore.prototype.identify = function (identify, eventOptions) {\n    var event = createIdentifyEvent(identify, eventOptions);\n    return this.dispatch(event);\n  };\n  AmplitudeCore.prototype.groupIdentify = function (groupType, groupName, identify, eventOptions) {\n    var event = createGroupIdentifyEvent(groupType, groupName, identify, eventOptions);\n    return this.dispatch(event);\n  };\n  AmplitudeCore.prototype.setGroup = function (groupType, groupName, eventOptions) {\n    var event = createGroupEvent(groupType, groupName, eventOptions);\n    return this.dispatch(event);\n  };\n  AmplitudeCore.prototype.revenue = function (revenue, eventOptions) {\n    var event = createRevenueEvent(revenue, eventOptions);\n    return this.dispatch(event);\n  };\n  AmplitudeCore.prototype.add = function (plugin) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        if (!this.config) {\n          this.q.push(this.add.bind(this, plugin));\n          return [2 /*return*/];\n        }\n\n        return [2 /*return*/, this.timeline.register(plugin, this.config)];\n      });\n    });\n  };\n  AmplitudeCore.prototype.remove = function (pluginName) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        if (!this.config) {\n          this.q.push(this.remove.bind(this, pluginName));\n          return [2 /*return*/];\n        }\n\n        return [2 /*return*/, this.timeline.deregister(pluginName)];\n      });\n    });\n  };\n  AmplitudeCore.prototype.dispatchWithCallback = function (event, callback) {\n    if (!this.config) {\n      return callback(buildResult(event, 0, CLIENT_NOT_INITIALIZED));\n    }\n    void this.process(event).then(callback);\n  };\n  AmplitudeCore.prototype.dispatch = function (event) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n      return __generator(this, function (_a) {\n        if (!this.config) {\n          return [2 /*return*/, new Promise(function (resolve) {\n            _this.dispatchQ.push(_this.dispatchWithCallback.bind(_this, event, resolve));\n          })];\n        }\n        return [2 /*return*/, this.process(event)];\n      });\n    });\n  };\n  AmplitudeCore.prototype.process = function (event) {\n    return __awaiter(this, void 0, void 0, function () {\n      var result, e_2, message, result;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            _a.trys.push([0, 2,, 3]);\n            // skip event processing if opt out\n            if (this.config.optOut) {\n              return [2 /*return*/, buildResult(event, 0, OPT_OUT_MESSAGE)];\n            }\n            return [4 /*yield*/, this.timeline.push(event)];\n          case 1:\n            result = _a.sent();\n            result.code === 200 ? this.config.loggerProvider.log(result.message) : this.config.loggerProvider.error(result.message);\n            return [2 /*return*/, result];\n          case 2:\n            e_2 = _a.sent();\n            message = String(e_2);\n            this.config.loggerProvider.error(message);\n            result = buildResult(event, 0, message);\n            return [2 /*return*/, result];\n          case 3:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n\n  AmplitudeCore.prototype.setOptOut = function (optOut) {\n    if (!this.config) {\n      this.q.push(this.setOptOut.bind(this, Boolean(optOut)));\n      return;\n    }\n    this.config.optOut = Boolean(optOut);\n  };\n  AmplitudeCore.prototype.flush = function () {\n    return this.timeline.flush();\n  };\n  return AmplitudeCore;\n}();\nexport { AmplitudeCore };","map":{"version":3,"sources":["../../src/core-client.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  CoreClient,\n  Config,\n  Event,\n  BaseEvent,\n  EventOptions,\n  Identify,\n  Plugin,\n  Revenue,\n  Result,\n} from '@amplitude/analytics-types';\nimport {\n  createGroupIdentifyEvent,\n  createIdentifyEvent,\n  createTrackEvent,\n  createRevenueEvent,\n  createGroupEvent,\n} from './utils/event-builder';\nimport { Timeline } from './timeline';\nimport { buildResult } from './utils/result-builder';\nimport { CLIENT_NOT_INITIALIZED, OPT_OUT_MESSAGE } from './messages';\n\nexport class AmplitudeCore<T extends Config> implements CoreClient<T> {\n  initializing = false;\n  name: string;\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  config: T;\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  timeline: Timeline;\n  protected q: CallableFunction[] = [];\n  protected dispatchQ: CallableFunction[] = [];\n\n  constructor(name = '$default') {\n    this.timeline = new Timeline();\n    this.name = name;\n  }\n\n  async _init(config: T) {\n    this.config = config;\n    this.timeline.reset();\n    await this.runQueuedFunctions('q');\n  }\n\n  async runQueuedFunctions(queueName: 'q' | 'dispatchQ') {\n    const queuedFunctions = this[queueName];\n    this[queueName] = [];\n    for (const queuedFunction of queuedFunctions) {\n      await queuedFunction();\n    }\n  }\n\n  track(eventInput: BaseEvent | string, eventProperties?: Record<string, any>, eventOptions?: EventOptions) {\n    const event = createTrackEvent(eventInput, eventProperties, eventOptions);\n    return this.dispatch(event);\n  }\n\n  logEvent = this.track.bind(this);\n\n  identify(identify: Identify, eventOptions?: EventOptions) {\n    const event = createIdentifyEvent(identify, eventOptions);\n    return this.dispatch(event);\n  }\n\n  groupIdentify(groupType: string, groupName: string | string[], identify: Identify, eventOptions?: EventOptions) {\n    const event = createGroupIdentifyEvent(groupType, groupName, identify, eventOptions);\n    return this.dispatch(event);\n  }\n\n  setGroup(groupType: string, groupName: string | string[], eventOptions?: EventOptions) {\n    const event = createGroupEvent(groupType, groupName, eventOptions);\n    return this.dispatch(event);\n  }\n\n  revenue(revenue: Revenue, eventOptions?: EventOptions) {\n    const event = createRevenueEvent(revenue, eventOptions);\n    return this.dispatch(event);\n  }\n\n  async add(plugin: Plugin) {\n    if (!this.config) {\n      this.q.push(this.add.bind(this, plugin));\n      return;\n    }\n    return this.timeline.register(plugin, this.config);\n  }\n\n  async remove(pluginName: string) {\n    if (!this.config) {\n      this.q.push(this.remove.bind(this, pluginName));\n      return;\n    }\n    return this.timeline.deregister(pluginName);\n  }\n\n  dispatchWithCallback(event: Event, callback: (result: Result) => void): void {\n    if (!this.config) {\n      return callback(buildResult(event, 0, CLIENT_NOT_INITIALIZED));\n    }\n    void this.process(event).then(callback);\n  }\n\n  async dispatch(event: Event): Promise<Result> {\n    if (!this.config) {\n      return new Promise<Result>((resolve) => {\n        this.dispatchQ.push(this.dispatchWithCallback.bind(this, event, resolve));\n      });\n    }\n\n    return this.process(event);\n  }\n\n  async process(event: Event): Promise<Result> {\n    try {\n      // skip event processing if opt out\n      if (this.config.optOut) {\n        return buildResult(event, 0, OPT_OUT_MESSAGE);\n      }\n\n      const result = await this.timeline.push(event);\n\n      result.code === 200\n        ? this.config.loggerProvider.log(result.message)\n        : this.config.loggerProvider.error(result.message);\n\n      return result;\n    } catch (e) {\n      const message = String(e);\n      this.config.loggerProvider.error(message);\n      const result = buildResult(event, 0, message);\n\n      return result;\n    }\n  }\n\n  setOptOut(optOut: boolean) {\n    if (!this.config) {\n      this.q.push(this.setOptOut.bind(this, Boolean(optOut)));\n      return;\n    }\n    this.config.optOut = Boolean(optOut);\n  }\n\n  flush() {\n    return this.timeline.flush();\n  }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}