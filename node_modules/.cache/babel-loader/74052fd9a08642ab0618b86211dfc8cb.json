{"ast":null,"code":"var _s = $RefreshSig$();\nimport { PERMIT2_ADDRESS } from '@uniswap/permit2-sdk';\nimport { useWeb3React } from '@web3-react/core';\nimport { AVERAGE_L1_BLOCK_TIME } from 'constants/chainInfo';\nimport useInterval from 'lib/hooks/useInterval';\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport { useHasPendingApproval } from 'state/transactions/hooks';\nimport { usePermitAllowance, useUpdatePermitAllowance } from './usePermitAllowance';\nimport { useTokenAllowance, useUpdateTokenAllowance } from './useTokenAllowance';\nvar SyncState;\n(function (SyncState) {\n  SyncState[SyncState[\"PENDING\"] = 0] = \"PENDING\";\n  SyncState[SyncState[\"SYNCING\"] = 1] = \"SYNCING\";\n  SyncState[SyncState[\"SYNCED\"] = 2] = \"SYNCED\";\n})(SyncState || (SyncState = {}));\nexport let PermitState;\n(function (PermitState) {\n  PermitState[PermitState[\"INVALID\"] = 0] = \"INVALID\";\n  PermitState[PermitState[\"LOADING\"] = 1] = \"LOADING\";\n  PermitState[PermitState[\"APPROVAL_OR_PERMIT_NEEDED\"] = 2] = \"APPROVAL_OR_PERMIT_NEEDED\";\n  PermitState[PermitState[\"APPROVAL_LOADING\"] = 3] = \"APPROVAL_LOADING\";\n  PermitState[PermitState[\"APPROVED_AND_PERMITTED\"] = 4] = \"APPROVED_AND_PERMITTED\";\n})(PermitState || (PermitState = {}));\nexport default function usePermit(amount, spender) {\n  _s();\n  const {\n    account\n  } = useWeb3React();\n  const {\n    tokenAllowance,\n    isSyncing: isApprovalSyncing\n  } = useTokenAllowance(amount === null || amount === void 0 ? void 0 : amount.currency, account, PERMIT2_ADDRESS);\n  const updateTokenAllowance = useUpdateTokenAllowance(amount, PERMIT2_ADDRESS);\n  const isAllowed = useMemo(() => amount && ((tokenAllowance === null || tokenAllowance === void 0 ? void 0 : tokenAllowance.greaterThan(amount)) || (tokenAllowance === null || tokenAllowance === void 0 ? void 0 : tokenAllowance.equalTo(amount))), [amount, tokenAllowance]);\n  const permitAllowance = usePermitAllowance(amount === null || amount === void 0 ? void 0 : amount.currency, spender);\n  const [permitAllowanceAmount, setPermitAllowanceAmount] = useState(permitAllowance === null || permitAllowance === void 0 ? void 0 : permitAllowance.amount);\n  useEffect(() => setPermitAllowanceAmount(permitAllowance === null || permitAllowance === void 0 ? void 0 : permitAllowance.amount), [permitAllowance === null || permitAllowance === void 0 ? void 0 : permitAllowance.amount]);\n  const isPermitted = useMemo(() => amount && (permitAllowanceAmount === null || permitAllowanceAmount === void 0 ? void 0 : permitAllowanceAmount.gte(amount.quotient.toString())), [amount, permitAllowanceAmount]);\n  const [signature, setSignature] = useState();\n  const updatePermitAllowance = useUpdatePermitAllowance(amount === null || amount === void 0 ? void 0 : amount.currency, spender, permitAllowance === null || permitAllowance === void 0 ? void 0 : permitAllowance.nonce, setSignature);\n  const isSigned = useMemo(() => amount && (signature === null || signature === void 0 ? void 0 : signature.details.token) === (amount === null || amount === void 0 ? void 0 : amount.currency.address) && (signature === null || signature === void 0 ? void 0 : signature.spender) === spender, [amount, signature === null || signature === void 0 ? void 0 : signature.details.token, signature === null || signature === void 0 ? void 0 : signature.spender, spender]);\n\n  // Trigger a re-render if either tokenAllowance or signature expire.\n  useInterval(() => {\n    // Calculate now such that the signature will still be valid for the next block.\n    const now = (Date.now() - AVERAGE_L1_BLOCK_TIME) / 1000;\n    if (signature && signature.sigDeadline < now) {\n      setSignature(undefined);\n    }\n    if (permitAllowance && permitAllowance.expiration < now) {\n      setPermitAllowanceAmount(undefined);\n    }\n  }, AVERAGE_L1_BLOCK_TIME, true);\n\n  // Permit2 should be marked syncing from the time approval is submitted (pending) until it is\n  // synced in tokenAllowance, to avoid re-prompting the user for an already-submitted approval.\n  const [syncState, setSyncState] = useState(SyncState.SYNCED);\n  const isApprovalLoading = syncState !== SyncState.SYNCED;\n  const hasPendingApproval = useHasPendingApproval(amount === null || amount === void 0 ? void 0 : amount.currency, PERMIT2_ADDRESS);\n  useEffect(() => {\n    if (hasPendingApproval) {\n      setSyncState(SyncState.PENDING);\n    } else {\n      setSyncState(state => {\n        if (state === SyncState.PENDING && isApprovalSyncing) {\n          return SyncState.SYNCING;\n        } else if (state === SyncState.SYNCING && !isApprovalSyncing) {\n          return SyncState.SYNCED;\n        } else {\n          return state;\n        }\n      });\n    }\n  }, [hasPendingApproval, isApprovalSyncing]);\n  const callback = useCallback(async () => {\n    let info;\n    if (!isAllowed && !hasPendingApproval) {\n      info = await updateTokenAllowance();\n    }\n    if (!isPermitted && !isSigned) {\n      await updatePermitAllowance();\n    }\n    return info;\n  }, [hasPendingApproval, isAllowed, isPermitted, isSigned, updatePermitAllowance, updateTokenAllowance]);\n  return useMemo(() => {\n    if (!amount) {\n      return {\n        state: PermitState.INVALID\n      };\n    } else if (!tokenAllowance || !permitAllowance) {\n      return {\n        state: PermitState.LOADING\n      };\n    } else if (!(isPermitted || isSigned)) {\n      return {\n        state: PermitState.APPROVAL_OR_PERMIT_NEEDED,\n        callback\n      };\n    } else if (!isAllowed) {\n      return {\n        state: isApprovalLoading ? PermitState.APPROVAL_LOADING : PermitState.APPROVAL_OR_PERMIT_NEEDED,\n        callback\n      };\n    } else {\n      return {\n        state: PermitState.APPROVED_AND_PERMITTED,\n        signature: isPermitted ? undefined : signature\n      };\n    }\n  }, [amount, callback, isAllowed, isApprovalLoading, isPermitted, isSigned, permitAllowance, signature, tokenAllowance]);\n}\n_s(usePermit, \"BOkCho+3xoikwPdElkd7laB+3dk=\", false, function () {\n  return [useWeb3React, useTokenAllowance, useUpdateTokenAllowance, usePermitAllowance, useUpdatePermitAllowance, useInterval, useHasPendingApproval];\n});","map":{"version":3,"names":["PERMIT2_ADDRESS","useWeb3React","AVERAGE_L1_BLOCK_TIME","useInterval","useCallback","useEffect","useMemo","useState","useHasPendingApproval","usePermitAllowance","useUpdatePermitAllowance","useTokenAllowance","useUpdateTokenAllowance","SyncState","PermitState","usePermit","amount","spender","account","tokenAllowance","isSyncing","isApprovalSyncing","currency","updateTokenAllowance","isAllowed","greaterThan","equalTo","permitAllowance","permitAllowanceAmount","setPermitAllowanceAmount","isPermitted","gte","quotient","toString","signature","setSignature","updatePermitAllowance","nonce","isSigned","details","token","address","now","Date","sigDeadline","undefined","expiration","syncState","setSyncState","SYNCED","isApprovalLoading","hasPendingApproval","PENDING","state","SYNCING","callback","info","INVALID","LOADING","APPROVAL_OR_PERMIT_NEEDED","APPROVAL_LOADING","APPROVED_AND_PERMITTED"],"sources":["/Applications/XAMPP/xamppfiles/htdocs/fohle-interface/src/hooks/usePermit2.ts"],"sourcesContent":["import { ContractTransaction } from '@ethersproject/contracts'\nimport { PERMIT2_ADDRESS } from '@uniswap/permit2-sdk'\nimport { CurrencyAmount, Token } from '@uniswap/sdk-core'\nimport { useWeb3React } from '@web3-react/core'\nimport { AVERAGE_L1_BLOCK_TIME } from 'constants/chainInfo'\nimport useInterval from 'lib/hooks/useInterval'\nimport { useCallback, useEffect, useMemo, useState } from 'react'\nimport { useHasPendingApproval } from 'state/transactions/hooks'\nimport { ApproveTransactionInfo } from 'state/transactions/types'\n\nimport { PermitSignature, usePermitAllowance, useUpdatePermitAllowance } from './usePermitAllowance'\nimport { useTokenAllowance, useUpdateTokenAllowance } from './useTokenAllowance'\n\nenum SyncState {\n  PENDING,\n  SYNCING,\n  SYNCED,\n}\n\nexport enum PermitState {\n  INVALID,\n  LOADING,\n  APPROVAL_OR_PERMIT_NEEDED,\n  APPROVAL_LOADING,\n  APPROVED_AND_PERMITTED,\n}\n\nexport interface Permit {\n  state: PermitState\n  signature?: PermitSignature\n  callback?: () => Promise<{\n    response: ContractTransaction\n    info: ApproveTransactionInfo\n  } | void>\n}\n\nexport default function usePermit(amount?: CurrencyAmount<Token>, spender?: string): Permit {\n  const { account } = useWeb3React()\n  const { tokenAllowance, isSyncing: isApprovalSyncing } = useTokenAllowance(amount?.currency, account, PERMIT2_ADDRESS)\n  const updateTokenAllowance = useUpdateTokenAllowance(amount, PERMIT2_ADDRESS)\n  const isAllowed = useMemo(\n    () => amount && (tokenAllowance?.greaterThan(amount) || tokenAllowance?.equalTo(amount)),\n    [amount, tokenAllowance]\n  )\n\n  const permitAllowance = usePermitAllowance(amount?.currency, spender)\n  const [permitAllowanceAmount, setPermitAllowanceAmount] = useState(permitAllowance?.amount)\n  useEffect(() => setPermitAllowanceAmount(permitAllowance?.amount), [permitAllowance?.amount])\n  const isPermitted = useMemo(\n    () => amount && permitAllowanceAmount?.gte(amount.quotient.toString()),\n    [amount, permitAllowanceAmount]\n  )\n\n  const [signature, setSignature] = useState<PermitSignature>()\n  const updatePermitAllowance = useUpdatePermitAllowance(\n    amount?.currency,\n    spender,\n    permitAllowance?.nonce,\n    setSignature\n  )\n  const isSigned = useMemo(\n    () => amount && signature?.details.token === amount?.currency.address && signature?.spender === spender,\n    [amount, signature?.details.token, signature?.spender, spender]\n  )\n\n  // Trigger a re-render if either tokenAllowance or signature expire.\n  useInterval(\n    () => {\n      // Calculate now such that the signature will still be valid for the next block.\n      const now = (Date.now() - AVERAGE_L1_BLOCK_TIME) / 1000\n      if (signature && signature.sigDeadline < now) {\n        setSignature(undefined)\n      }\n      if (permitAllowance && permitAllowance.expiration < now) {\n        setPermitAllowanceAmount(undefined)\n      }\n    },\n    AVERAGE_L1_BLOCK_TIME,\n    true\n  )\n\n  // Permit2 should be marked syncing from the time approval is submitted (pending) until it is\n  // synced in tokenAllowance, to avoid re-prompting the user for an already-submitted approval.\n  const [syncState, setSyncState] = useState(SyncState.SYNCED)\n  const isApprovalLoading = syncState !== SyncState.SYNCED\n  const hasPendingApproval = useHasPendingApproval(amount?.currency, PERMIT2_ADDRESS)\n  useEffect(() => {\n    if (hasPendingApproval) {\n      setSyncState(SyncState.PENDING)\n    } else {\n      setSyncState((state) => {\n        if (state === SyncState.PENDING && isApprovalSyncing) {\n          return SyncState.SYNCING\n        } else if (state === SyncState.SYNCING && !isApprovalSyncing) {\n          return SyncState.SYNCED\n        } else {\n          return state\n        }\n      })\n    }\n  }, [hasPendingApproval, isApprovalSyncing])\n\n  const callback = useCallback(async () => {\n    let info\n    if (!isAllowed && !hasPendingApproval) {\n      info = await updateTokenAllowance()\n    }\n    if (!isPermitted && !isSigned) {\n      await updatePermitAllowance()\n    }\n    return info\n  }, [hasPendingApproval, isAllowed, isPermitted, isSigned, updatePermitAllowance, updateTokenAllowance])\n\n  return useMemo(() => {\n    if (!amount) {\n      return { state: PermitState.INVALID }\n    } else if (!tokenAllowance || !permitAllowance) {\n      return { state: PermitState.LOADING }\n    } else if (!(isPermitted || isSigned)) {\n      return { state: PermitState.APPROVAL_OR_PERMIT_NEEDED, callback }\n    } else if (!isAllowed) {\n      return {\n        state: isApprovalLoading ? PermitState.APPROVAL_LOADING : PermitState.APPROVAL_OR_PERMIT_NEEDED,\n        callback,\n      }\n    } else {\n      return { state: PermitState.APPROVED_AND_PERMITTED, signature: isPermitted ? undefined : signature }\n    }\n  }, [\n    amount,\n    callback,\n    isAllowed,\n    isApprovalLoading,\n    isPermitted,\n    isSigned,\n    permitAllowance,\n    signature,\n    tokenAllowance,\n  ])\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}